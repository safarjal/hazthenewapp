<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
	<!-- This is a comment in html -->
	<!-- This loads a file containing a program written in javascript
		 Ideally we should separate text, programs, and formatting.
		 To start with it is easiest to keep it all together
		 Currently the program file is empty -->
    <script src="scripts/hazapp.js"></script>
	<!-- This loads a css file to show exactly how to format objects
		 Currently the file is empty -->
    <link rel="stylesheet" type="text/css" href="css/hazapp.css">
	<!-- This is where we keep the program currently. When done we will
         move it out to the js file	-->
	<script>
		"use strict"		// this should usually be the first line, catches many errors
		// Also useful in browser to right click and "Inspect Element"
		//    this opens an inspector window in the lower half
		//    open the console tab, and you can see error messages
		//    you can also print the values of variables to debug here
		
		// This start is called just once, and the call is at the end of the file.
		// It needs to be at the end, so that when it is called, all of the file
		// has been read in, so that all the ids and stuff exist for the program to run.
		// Once it has run, hooks are set up, so that whenever any input changes,
		// the inputHandler function is called.
		
		// TESTING
		//  MP<GP     GP==MP        |   MP>GP
		//  X = dm-(gp-mp)          |   X = hz-(MP-GP)
		//  X1 < 3 <= X2 < hz <= X3  |   X1 < 0 < X2 < 3 <= X3
		//   what if HZ<3?
		//
		//	MP,GP = (26,19)
		//  X = DM-7
		//  X7=7 DM,HZ = (14,6) 
		//  X6=6 DM,HZ = (13,6)
		//  X5=5 DM,HZ = (12,6)
		//  X4=3 DM,HZ = (10,6)
		//  X3=1 DM,HZ = (8,6)
		//  X2=0 DM,HZ = (7,6)
		//  X1<0 DM,HZ = (6,6)
		
		//	MP,GP = (23,23) |    (19,26)    
		//  X = DM
		//  X7=7 DM,HZ = (7,6) 
		//  X6=6 DM,HZ = (6,6)
		//  X5=5 DM,HZ = (5,6)
		//  X4=3 DM,HZ = (3,6)
		//  X3=1 DM,HZ = (1,6)
		//  X2=0 DM,HZ = (0,6)  ?
		//  X1<0 DM,HZ = (-1,6) ?

		//	MP,GP = (19,26)    
		//  X = HZ-7
		//  X7=7 DM,HZ = (6,6) 
		//  X6=6 DM,HZ = (6,6)
		//  X5=5 DM,HZ = (5,6)
		//  X4=3 DM,HZ = (3,6)
		//  X3=1 DM,HZ = (1,6)
		//  X2=0 DM,HZ = (0,6)  ?
		//  X1<0 DM,HZ = (-1,6) ?

		function daysHoursMinutes(days){
				days = days*24*60; //This is actually in minutes now
				var minutes=days%60;								
				days = (days - minutes)/60; //now days is in hours
				var hours = days % 24;
				var days = (days - hours)/24;
				minutes=Math.round(minutes);
				hours=Math.round(hours);
				days=Math.round(days);
				if (days == 0){days = ``;} 
				else if(days == 1){days = `1 day`;}
				else{days = `${days} days`;}

				if (hours == 0){hours = ``; }
				else if (hours == 1){hours = `1 hour`;}
				else{hours = `${hours} hours`;}

				if (minutes == 0){minutes = ``;}
				else if(minutes == 1){minutes = `1 minute`;}
				else{minutes = `${minutes} minutes`;}

				var returnStatement;

				if(hours==``){
					returnStatement = `${days}, ${minutes}`;
				}else{
					returnStatement = `${days}, ${hours}, ${minutes}`;
				}


				if(returnStatement.startsWith(`, `)){
					returnStatement = returnStatement.slice(2, returnStatement.length);
				}if(returnStatement.endsWith(`, `)){
					returnStatement = returnStatement.slice(0, returnStatement.length-2);
				}

				return(returnStatement);
		}

		function formatDateTime(date){
			//Sat Feb 13 2021 00:00:00 GMT+0500 (Pakistan Standard Time)
			date = date.slice(0,24);//all GMT stuff removed
			var dayOfWeek = date.slice(0,3);
			var month = date.slice(4,7);
			var day = Number(date.slice(8,10));
			var year = date.slice(11,15);
			var hours = Number(date.slice(16,18));
			var ampm = "am";
			var minutes = date.slice(19,21);
			var seconds = date.slice(22,24);
			if (hours > 12){
				hours = hours - 12;
				ampm = "pm";
			}if (hours == 0){
				hours = 12;
			}

			if (hours == 12 && minutes == "00" && ampm == "am"){
				date = `${month} ${day}, ${year}`;

			}else{
				date = `${hours}:${minutes} ${ampm}, ${month} ${day}, ${year}`;
			}


			return (date);

		}


		var tab = "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;";


		function daysHoursMinutesDigital(days){
				days = days*24*60; //This is actually in minutes now
				var minutes=days%60;								
				days = (days - minutes)/60; //now days is in hours
				var hours = days % 24;
				var days = (days - hours)/24;
				minutes=Math.round(minutes);
				hours=Math.round(hours);
				days=Math.round(days);
				if(hours<10){
					hours = `0${hours}`;
				}
				if(minutes<10){
					minutes = `0${minutes}`;
				}
				if(days == 0){
					returnStatement = `${days}d:${hours}h:${minutes}m`;
				}
				var returnStatement = `${days}d:${hours}h:${minutes}m`;
				return(returnStatement);
		}
		
		function gid(id) { return document.getElementById(id) }
		function start() {
			// this defines a function called gid, which is equivalent to
			// the builtin function document.getElementById. It is very
			// often used, so a short name is nice
			function print_soorat(cond, soorat) {
				gid('cond').innerHTML = cond;
				gid('soorat').innerHTML = soorat;
			}
			function print_days(hukm, val, type) {
				gid('val' + hukm).innerHTML = val
				gid('type' + hukm).innerHTML = type
				if (hukm == 1)      { gid('hukm2').classList.add('hide'); }
				else if (hukm == 2) { gid('hukm2').classList.remove('hide'); }
			}
			function print_aadat(namehz, valhz, namegp, valgp) {
				gid('samehz').innerHTML = namehz == 'hz' ? 'remains the same' : 'changes to';
				gid('valhz').innerHTML = valhz
				gid('samegp').innerHTML = namegp == 'gp' ? 'remains the same' : 'changes to';
				gid('valgp').innerHTML = valgp
			}
			const inputs = ['mpdays', 'mphours', 'mpminutes', 
							'gpdays', 'gphours', 'gpminutes', 
							'dmdays', 'dmhours', 'dmminutes', 
							'hzdays', 'hzhours', 'hzminutes'];
			// this function is called any time any of the four times 3 inputs are changed
			// it updates the values of all the text in the html
			const inputHandler = function(e) {
				var [mpdays, mphours, mpminutes, 
					gpdays, gphours, gpminutes, 
					dmdays, dmhours, dmminutes, 
					hzdays, hzhours, hzminutes] = inputs.map(function (inp) { return Number(gid(inp).value); });
				
				var mp = mpdays + (mphours/24) + (mpminutes/(24*60));//These 4 lines convert everything to hours
				var gp = gpdays + (gphours/24) + (gpminutes/(24*60));
				var dm = dmdays + (dmhours/24) + (dmminutes/(24*60));
				var hz = hzdays + (hzhours/24) + (hzminutes/(24*60));


				
				gid('dam').innerHTML = daysHoursMinutes(dm);
				if (mp <= gp) {    //Qism A
					gid('comp').innerHTML = '&leq;';
					gid('AorB').innerHTML = 'A';
					gid('dif').innerHTML = daysHoursMinutes(gp - mp);
					if (hz <= dm - (gp - mp)) {	                  // soorat A-1
						print_soorat(`${daysHoursMinutes(dm)} (dam) - ${daysHoursMinutes(gp-mp)} (difference of pakis) = ${daysHoursMinutes(dm-(gp-mp))} &geq; ${daysHoursMinutes(hz)} (haiz)`, 'A-1');
						// if GP==MP, we would output 0 istihaza, not good!
						// 0 istihaza is ok, for now. just no negative numbers, please
						print_days(1, `${daysHoursMinutes(gp-mp)}`,      'istihaza');
						print_days(2, `${daysHoursMinutes(hz)}`,            'haiz');
						// what if DM = HZ + (GP-MP), then we would have 0 istihza, not good!
						//0 istihaza is ok
						print_days(3, `${daysHoursMinutes(dm-(gp-mp)-hz)}`, 'istihaza');
						print_aadat('hz', daysHoursMinutes(hz), 'gp', daysHoursMinutes(gp));
					}
					else if (3 <= dm-(gp-mp) && dm-(gp-mp) < hz) {  // soorat A-2
						print_soorat(`${daysHoursMinutes(dm)} (dam) - ${daysHoursMinutes(gp-mp)} (difference of pakis) = ${daysHoursMinutes(dm-(gp-mp))} and 3 days &leq; ${daysHoursMinutes(dm-(gp-mp))} &lt; ${daysHoursMinutes(hz)} (haiz)`, 'A-2');
						print_days(1, `${daysHoursMinutes(gp-mp)}`, 'istihaza');
						print_days(3, `${daysHoursMinutes(dm-(gp-mp))}`, 'haiz');
						print_aadat('DM–(GP–MP)', daysHoursMinutes(dm-(gp-mp)), 'gp', daysHoursMinutes(gp));
					}
					else if (dm - (gp - mp) < 3) {                  // soorat A-3
						if (gp - mp > dm) //this if is added because there is a horror of seeing negative numbers
							print_soorat(`${daysHoursMinutes(gp-mp)} (difference of pakis) &gt; ${daysHoursMinutes(dm)} (dam)`, 'A-3');
						else 
							print_soorat(`${daysHoursMinutes(dm)} (dam) - ${daysHoursMinutes(gp-mp)} (difference of pakis) = ${daysHoursMinutes(dm-(gp-mp))} &lt; 3 days`, 'A-3');
						print_days(1, `${daysHoursMinutes(hz)}`, 'haiz');
						print_days(3, `${daysHoursMinutes(dm-hz)}`, 'istihaza');
						print_aadat('hz', daysHoursMinutes(hz), 'MP', daysHoursMinutes(mp));
					}
				}				
				else {	// mp>gp qism B
					gid('comp').innerHTML = '&gt;';
					gid('AorB').innerHTML = 'B';
					gid('dif').innerHTML = daysHoursMinutes(mp - gp);
					if (hz - (mp - gp) >= 3) {							// soorat B-2
						print_soorat(`${daysHoursMinutes(hz)} (haiz) - ${daysHoursMinutes(mp-gp)} (difference of pakis) = ${daysHoursMinutes(hz-(mp-gp))} &geq; 3 days`,'B-2')
						print_days(1, `${daysHoursMinutes(hz-(mp-gp))}`, 'haiz')
						print_days(3, `${daysHoursMinutes(dm-(hz-(mp-gp)))}`, 'istihaza')
						print_aadat('HZ–(MP–GP)', daysHoursMinutes(hz-(mp-gp)), 'MP', daysHoursMinutes(mp))
					}
					else if (hz - (mp - gp) < 3) {						// soorat B-3
						if (mp - gp > hz) //this if is added because there is a horror of seeing negative numbers
							print_soorat(`${daysHoursMinutes(mp-gp)} (difference of pakis) &gt; ${daysHoursMinutes(hz)} (haiz)`, 'B-3')
						else
							print_soorat(`${daysHoursMinutes(hz)} (haiz) - ${daysHoursMinutes(mp-gp)} (difference of pakis) = ${daysHoursMinutes(hz-(mp-gp))} &lt; 3, `, 'B-3')
						print_days(1, `${daysHoursMinutes(hz)}`, 'haiz')
						print_days(3, `${daysHoursMinutes(dm-hz)}`, 'istihaza')
						print_aadat('hz', daysHoursMinutes(hz), 'mp', daysHoursMinutes(mp))
					}
				}
			}
			// this sets listeners so that if any change happens in the input boxes,
			// the inputHandler function is called. 
			inputs.forEach(function (inp) { gid(inp).addEventListener('input', inputHandler) });
			inputHandler(0);
		}

		function calculateDuration(){
			var diff = Math.abs(new Date(gid("strtTime").value)- new Date(gid("endTime").value))/60000; //This gives the diff in minutes
			var minutes = diff % 60;
			diff = (diff - minutes)/60; //now diff is in hours
			var hours = diff % 24;
			var days = (diff - hours)/24;
			gid("duration").innerHTML = `${days} days, ${hours} hours, ${minutes} minutes`;
		}

		function addTime(){

			var date = gid("strtTime1").value;
			var timeInDays = (Number(gid("addTimeMinutes").value) + 60*Number(gid("addTimeHours").value) + 60*24*Number(gid("addTimeDays").value))/1440;
			gid("addedTime").innerHTML = addTimeToDate(date,timeInDays);

		}

		function addTimeToDate(date, timeInDays){
			var oldTime = new Date(date)/60000; //This gives the date in minutes
			var additionalTime = timeInDays*1440; //This value is also in minutes

			var newTime = (oldTime + additionalTime)*60000; //This value is in milisecond
			newTime = `${new Date(newTime)}`;
			return(newTime);
		}

		var dima = [];

		function submitDimaAthaarN(){
			getValuesN();
		}

		function getValuesN(){
			var value = gid("numberofdaysN").value;
			var type = 5;//5 is not a type if it turns up 5, there's an error
			if (value == "istimrar" || value == "istimraar" || value == " istimraar"|| value == "istimraar " || value == " istimraar " || value == " istimrar" || value == "istimrar " || value == " istimrar " || value == "Istimrar" || value == "Istimraar" || value == " Istimraar"|| value == "Istimraar " || value == " Istimraar " || value == " Istimrar" || value == "Istimrar " || value == " Istimrar "){//alternative spellings for idiot proofing
				value = -1; //we will use negative one for istimrar
				gid("submitButtonN").disabled=true; //disable submit button, no additional values allowed
			}
			var damTuhurSpotN = document.getElementsByName("damtuhurspotN");
			for (var i = 0, length = damTuhurSpotN.length; i < length; i++) {
 				 if (damTuhurSpotN[i].checked) {
    				// do whatever you want with the checked radio
    				type = damTuhurSpotN[i].value;

  					// only one radio can be logically checked, don't check the rest
    				break;
  				}
			}
			if (value == 0 && type != 2){//if the type is not spot, the value shouldn't be zero. if it is, it's a mistake. do not do anything else
				return;

			}
			if (value == -1){//if it's istimrar
				type = 0; //if it was set to something else, it should be autocorrected to dam. someone made a mistake
			}
			var textToPrint = printValues(value, type); //Step 1: Write all the info with arrows
			gid("solutionN").innerHTML = `${textToPrint}`;

			if (type == 2){ //convert spots to dam
				type =0;
			}

			putValueInPeriodsArray(value,type);
			var fixedPeriods = fixPeriodsArrayN();
			var periodsoutput = printPeriodsArray(fixedPeriods);
			gid("hallN").innerHTML = `${periodsoutput}`;


		}

		function submitDimaAthaarN(){
			getValuesN();
		}

		function submitDimaAthaar(){
			getValues();
		}

		function getValues(){
			var value = gid("numberofdays").value;
			var type = 5;//5 is not a type if it turns up 5, there's an error
			if (value == "istimrar" || value == "istimraar" || value == " istimraar"|| value == "istimraar " || value == " istimraar " || value == " istimrar" || value == "istimrar " || value == " istimrar " || value == "Istimrar" || value == "Istimraar" || value == " Istimraar"|| value == "Istimraar " || value == " Istimraar " || value == " Istimrar" || value == "Istimrar " || value == " Istimrar "){//alternative spellings for idiot proofing
				value = -1; //we will use negative one for istimrar
				gid("submitButton").disabled=true; //disable submit button, no additional values allowed
			}
			var damTuhurSpot = document.getElementsByName("damtuhurspot");
			for (var i = 0, length = damTuhurSpot.length; i < length; i++) {
 				 if (damTuhurSpot[i].checked) {
    				// do whatever you want with the checked radio
    				type = damTuhurSpot[i].value;

  					// only one radio can be logically checked, don't check the rest
    				break;
  				}
			}
			if (value == 0 && type != 2){//if the type is not spot, the value shouldn't be zero. if it is, it's a mistake. do not do anything else
				return;

			}
			if (value == -1){//if it's istimrar
				type = 0; //if it was set to something else, it should be autocorrected to dam. someone made a mistake
			}
			var textToPrint = printValues(value, type); //Step 1: Write all the info with arrows
			gid("solution").innerHTML = `${textToPrint}`;

			if (type == 2){ //convert spots to dam
				type =0;
			}
			putValueInPeriodsArray(value,type);
			var fixedPeriods = fixPeriodsArray();
			var periodsoutput = printPeriodsArray(fixedPeriods);
			gid("hall").innerHTML = `${periodsoutput}`;

		}

		var textToPrint="";
		var periods = [];

		function putValueInPeriodsArray (v,typ){
			var period = [+v,+typ]; //the plus is to avoid storing them as strings
			periods.push(period);
		}

		function copy(aObject) {
 			if (!aObject) {
 			   return aObject;
 			}
 			let v;
 			let bObject = Array.isArray(aObject) ? [] : {};
 			for (const k in aObject) {
 				v = aObject[k];
 				bObject[k] = (typeof v === "object") ? copy(v) : v;
 			}
 			return bObject;
 		}

 		function joinMuttasilPeriods(fixedPeriods){
			//Step 0: Go through all the periods. Join all muttasil things of the same type.
			for (var i = 0; i < fixedPeriods.length - 1; i++) {
				var currentPeriod = fixedPeriods[i];
				var nextPeriod = fixedPeriods[(i+1)];

				if (currentPeriod[1]==0 && nextPeriod[0]==-1){//if there is a dam before to istimrar, make it all istimrar.		


					currentPeriod[1]=0; //in istimrar, type is dam
					currentPeriod[0]=-1; //and value is -1

					//store position of next period in current period
					currentPeriod[2] = currentPeriod[2].concat(nextPeriod[2]);

					fixedPeriods[i]=currentPeriod; //make this the current period
					fixedPeriods.splice(i+1,1); // delete next period
				}

				if (currentPeriod[1]==nextPeriod[1] && nextPeriod[0] != -1){//if type of current and next period is same and it's not istimrar
					currentPeriod[0]= currentPeriod[0] + nextPeriod[0]; //add their values
					//store position of next period in current period
					currentPeriod[2] = currentPeriod[2].concat(nextPeriod[2]);

					fixedPeriods.splice(i+1,1);//remove next period
					fixedPeriods[i] = currentPeriod; //put changed period in here
					i=i-1;
				}
			}
			return(fixedPeriods);

 		}

 		function removeTuhrENaaqis(fixedPeriods){
 			for (var i = 1; i < fixedPeriods.length - 1; i++) {
				var previousPeriod = fixedPeriods[i-1];
				var currentPeriod = fixedPeriods[i];
				var nextPeriod = fixedPeriods[(i+1)];
				if (currentPeriod[0]<15 && currentPeriod[1]==1 ){//if value is less than 15 and type is tuhur
					if(nextPeriod[0]==-1 && nextPeriod[1]==0){//add check for istimrar in next period
						//store position of current period and previous period in nextPeriod
						nextPeriod[2] = nextPeriod[2].concat(previousPeriod[2],currentPeriod[2]);
						fixedPeriods[i+1] = nextPeriod;

						//it all becomes istimrar, so delete current period, and the one behind it.
						fixedPeriods.splice(i-1, 2); //remove previous period, and current period
						i=i-1;
					}else{//no istimrar
						previousPeriod[0]= previousPeriod[0] + currentPeriod[0] + nextPeriod[0]; //add their values
						//store position of current period and next period in previousPeriod
						previousPeriod[2] = previousPeriod[2].concat(currentPeriod[2],nextPeriod[2]);

						fixedPeriods.splice(i, 2); //remove current period, and next period
						fixedPeriods[i-1] = previousPeriod; //put changed period in here
						i=i-1;//move i one back
					}
				}
			}

			return(fixedPeriods);
 		}

 		function removeDamLessThanThree(fixedPeriods){
			for (var i = 1; i < fixedPeriods.length - 1; i++) {
				var previousPeriod = fixedPeriods[i-1];
				var currentPeriod = fixedPeriods[i];
				var nextPeriod = fixedPeriods[(i+1)];
				if (currentPeriod[0]<3 && currentPeriod[0] >= 0 && currentPeriod[1]==0 ){//if value is less than 3 (but not istimrar) and type is dam

					previousPeriod[0]= previousPeriod[0] + currentPeriod[0] + nextPeriod[0]; //add their values

					//store position of current period and next period in previousPeriod
					previousPeriod[2] = previousPeriod[2].concat(currentPeriod[2],nextPeriod[2]);

					previousPeriod[1]= 3; // type 3 is for tuhur e faasid
					fixedPeriods.splice(i, 2); //remove current period, and next period
					fixedPeriods[i-1] = previousPeriod; //put changed period in here
					i=i-1;//move i one back
				}
			}

 			return(fixedPeriods);
 		}

 		function formatDateTime(date){
 			//Sat Feb 13 2021 00:00:00 GMT+0500 (Pakistan Standard Time)
 			date = date.slice(0,24);//all GMT stuff removed
 			var dayOfWeek = date.slice(0,3);
 			var month = date.slice(4,7);
 			var day = Number(date.slice(8,10));
 			var year = date.slice(11,15);
 			var hours = Number(date.slice(16,18));
 			var ampm = "am";
 			var minutes = date.slice(19,21);
 			var seconds = date.slice(22,24);
 			if (hours > 12){
 				hours = hours - 12;
 				ampm = "pm";
 			}if (hours == 0){
 				hours = 12;
 			}

 			if (hours == 12 && minutes == "00" && ampm == "am"){
 				date = `${month} ${day}, ${year}`;

 			}else{
 				date = `${hours}:${minutes} ${ampm} on ${month} ${day}, ${year}`;
 			}


 			return (date);

 		}

 		function createAskAgainLineForIstimrar(endTimeOfHaz,aadatTuhr, aadatHaiz){
 			var now = new Date();

 			var diff = Math.abs((new Date(now)- new Date(endTimeOfHaz))/60000); //This gives the diff in minutes
 			var returnDays = diff/(60*24);

 			aadatTuhr = Number(aadatTuhr);
 			aadatHaiz = Number(aadatHaiz);


 			var askAgainTime;
 			var askAgainLine = ``;

 			var whereWeAreNow = (returnDays) % (aadatTuhr+aadatHaiz);//find out remainder after cycles
 			if (whereWeAreNow>aadatTuhr){
 				askAgainTime = addTimeToDate(now, (aadatTuhr+aadatHaiz-whereWeAreNow)); 
 				askAgainLine = `${tab}According to today's date, you are currently in a state of haiz. If your bleeding continues, you should ask again on ${formatDateTime(askAgainTime)}.<br>`

 			}else{
 				askAgainTime = addTimeToDate(now, (aadatTuhr - whereWeAreNow));
 				askAgainLine = `${tab}According to today's date, you are currently in a state of istihaza, yaqeeni paki. If your bleeding continues, you should ask again on ${formatDateTime(askAgainTime)}.<br>`
 			}



 			var writeDownInfoLine = `${tab}Please write down the date and time for the start or end of any bleeding or spotting you experience.<br>`;

 			askAgainLine = `${askAgainLine}${writeDownInfoLine}`;

 			return(askAgainLine);
 		}

 		function createAskAgainLineForDamBiggerThan10(startTimeOfCurrentPeriod,gp,hz,startTimeOfHaz,endTimeOfHaz, endTimeOfIstihazaAfter, aadatTuhr, qism){
 			var askAgainTime;
 			var askAgainLine = ``;
 			var now = new Date();

 			//when to ask again
 			if(qism == "A-3"){
 				//ask again if bleeding continues till start of aadat
 				askAgainTime = addTimeToDate(startTimeOfCurrentPeriod, gp);
 				var gapOf15 = ``;
 				if(askAgainTime - endTimeOfIstihazaAfter >= 15){
 					gapOf15 = `without a gap of 15 days or more, `;
 				}
 				askAgainLine = `Currently you are in a state of istihaza, yaqeeni paki, and you should continue your ibadaat. However if your bleeding continues to ${formatDateTime(askAgainTime)} ${gapOf15}you should ask again, as the soorat of the masla will have changed.<br>`

 			}else if (qism == "A-2"){
 				//ask again if bleeding continues till end of aadat.
 				//use hz, not aadat haiz, as aadat haiz changes.
 				askAgainTime = addTimeToDate(startTimeOfHaz,hz);
 				askAgainLine = `Currently you are in a state of haiz, and you should not pray or fast. If your bleeding continues to ${formatDateTime(askAgainTime)}, you should ask again.<br>`


 			}else{
 				//in A-1, B-2 and B-3 they all end with istihaza.
 				//ask again if bleeding continues to the next aadat.

 				askAgainTime = addTimeToDate(endTimeOfHaz, aadatTuhr);
 				var gapOf15 = ``;
 				if(askAgainTime - endTimeOfIstihazaAfter >= 15){
 					gapOf15 = `without a gap of 15 days or more, `;
 				}

 				askAgainLine = `Currently you are in a state of istihaza, yaqeeni paki, and you should continue your ibadaat. However if your bleeding continues to ${formatDateTime(askAgainTime)} ${gapOf15}you should ask again.<br>`

 			}
 			askAgainLine = `${tab}${askAgainLine}`;

 			if(new Date(askAgainTime)<now){//if ask again time has already passed, there is no point to issing an ask again line,
 				askAgainLine = ``;
 			}
 			var writeDownInfoLine = `${tab}Please write down the date and time for the start or end of any bleeding or spotting you experience.<br>`;
 			askAgainLine = `${askAgainLine}${writeDownInfoLine}`;
 			return(askAgainLine);
 		}

 		function printAnswerToIstimrar(mp,gp,hz,qism, istihazaBefore, haz, aadatTuhr, aadatHaiz, startTimeOfCurrentPeriod){
 			var outputString = "";
 			var outputStringTitleLine = `${tab}${daysHoursMinutesDigital(mp)}${tab}${daysHoursMinutesDigital(gp)}${tab}Istimrar${tab}${daysHoursMinutesDigital(hz)}${tab}${qism}<br>`;
 			var outputStringHukmLine = `${tab}Hukm: From the beginning of istimrar, the first `;

 			if(istihazaBefore>0){//if there is istihaza before
 				outputStringHukmLine = `${outputStringHukmLine}${daysHoursMinutes(istihazaBefore)} are istihaza, the next ${daysHoursMinutes(haz)} are haiz, then until the end of dam, there is a cycle of ${daysHoursMinutes(aadatTuhr)} of tuhur, and ${daysHoursMinutes(aadatHaiz)} of haiz.<br>`;

 			}else{//there is no istihaza before
 				outputStringHukmLine = `${outputStringHukmLine}${daysHoursMinutes(haz)} are haiz, then until the end of dam, there is a cycle of ${daysHoursMinutes(aadatTuhr)} of tuhur, and ${daysHoursMinutes(aadatHaiz)} of haiz.<br>`;
  			}

 			var outputStringAadatLine = `${tab}Aadat: ${daysHoursMinutes(aadatHaiz)}/${daysHoursMinutes(aadatTuhr)} <br>`;
 			outputString = `${outputStringTitleLine}${outputStringAadatLine}${outputStringHukmLine} <br>`;
 			//write hukm in dates
 			if (startDateForQuestion != -1){//there is a date in this question
 				var startTimeOfIstihazaBefore = startTimeOfCurrentPeriod;
 				var endTimeOfIstihazaBefore = addTimeToDate(startTimeOfCurrentPeriod, istihazaBefore);
 				var startTimeOfHaz = endTimeOfIstihazaBefore;
 				var endTimeOfHaz = addTimeToDate(startTimeOfHaz, haz);

 				var askAgainLine = createAskAgainLineForIstimrar(endTimeOfHaz,aadatTuhr, aadatHaiz);

 				var tuhur1EndTime = addTimeToDate(endTimeOfHaz, aadatTuhr);
 				var haiz1EndTime = addTimeToDate(tuhur1EndTime, aadatHaiz);
 				var tuhur2EndTime = addTimeToDate(haiz1EndTime, aadatTuhr);
 				var haiz2EndTime = addTimeToDate(tuhur2EndTime, aadatHaiz);
 				var tuhur3EndTime = addTimeToDate(haiz2EndTime, aadatTuhr);
 				var haiz3EndTime = addTimeToDate(tuhur3EndTime, aadatHaiz);

 				var istihazaBeforeLine = `${tab}From ${formatDateTime(startTimeOfIstihazaBefore)} to ${formatDateTime(endTimeOfIstihazaBefore)} is istihaza, yaqeeni paki. If you didn't pray namaz or keep roza in these dates, due to the assumption of haiz, you must repeat these namaz and rozas.<br>`;

 				var hazLine = `${tab}From ${formatDateTime(startTimeOfHaz)} to ${formatDateTime(endTimeOfHaz)} are your haiz dates. Any prayers or fasts in this time are null and void.<br>`;

 				var daurLine = `${tab}From ${formatDateTime(endTimeOfHaz)} there will be a cycle of ${daysHoursMinutes(aadatTuhr)}  of tuhur and ${daysHoursMinutes(aadatHaiz)} of haiz. The first 3 cycles are as follows:<br>&nbsp;<br>`;
 				daurLine = `${daurLine}${tab}From ${formatDateTime(endTimeOfHaz)} to ${formatDateTime(tuhur1EndTime)} is tuhur. <br>`;
 				daurLine = `${daurLine}${tab}From ${formatDateTime(tuhur1EndTime)} to ${formatDateTime(haiz1EndTime)} is haiz. <br>`;
 				daurLine = `${daurLine}${tab}From ${formatDateTime(haiz1EndTime)} to ${formatDateTime(tuhur2EndTime)} is tuhur. <br>`;
 				daurLine = `${daurLine}${tab}From ${formatDateTime(tuhur2EndTime)} to ${formatDateTime(haiz2EndTime)} is haiz. <br>`;
 				daurLine = `${daurLine}${tab}From ${formatDateTime(haiz2EndTime)} to ${formatDateTime(tuhur3EndTime)} is tuhur. <br>`;
 				daurLine = `${daurLine}${tab}From ${formatDateTime(tuhur3EndTime)} to ${formatDateTime(haiz3EndTime)} is haiz. <br>`;



 				var outputStringInDates = ``;

 				if(istihazaBefore>0){//if there is istihaza before
 					outputStringInDates = `${istihazaBeforeLine}${hazLine}${daurLine}`;
 				}else{//there is no istihaza before, there must be istihaza after
 					outputStringInDates = `${hazLine}${daurLine}`;
 				}
 		
 				
 				var output = [];
 				output[0] = outputString;
 				output[1] = outputStringInDates;
 				output[2] = askAgainLine;

 				return(output);							
 			}

 		}


 		function printAnswerToDamBiggerThan10(mp,gp,dm,hz,qism, istihazaBefore, haz, istihazaAfter, aadatTuhr, aadatHaiz, startTimeOfCurrentPeriod, dividend, remainder, newAadatHaiz, newIstihazaAfter){

 			var outputString = "";
 			var outputStringTitleLine = `${tab}${daysHoursMinutesDigital(mp)}${tab}${daysHoursMinutesDigital(gp)}${tab}${daysHoursMinutesDigital(dm)}${tab}${daysHoursMinutesDigital(hz)}${tab}${qism}<br>`;
 			var outputStringHukmLine = `${tab}Hukm: Out of ${daysHoursMinutes(dm)} of dam, the first `;

 			if(istihazaBefore>0){//if there is istihaza before
	 			outputStringHukmLine = `${outputStringHukmLine}${daysHoursMinutes(istihazaBefore)} are istihaza`;
 				if(istihazaAfter>0){//if there is istihaza after as well
 					if(newIstihazaAfter!=-1){//this is if it's a long istihaza. it'll either be 0, or another value.
	 					outputStringHukmLine = `${outputStringHukmLine}, the next ${daysHoursMinutes(haz)} are haiz, `;
	 					var repeatingLine = `then the next ${daysHoursMinutes(aadatTuhr)} are istihaza, then the next ${daysHoursMinutes(aadatHaiz)} are haiz, `;
	 					var line2 = ``;
	 					var line3 = ``;
	 					for (var i=0; i<dividend; i++){//repeat this line the correct nmber of cycles.
	 						line2 = `${line2}${repeatingLine}`;
	 					}
	 					if(remainder>=aadatTuhr+3){
		 					 line3 = `then the next ${daysHoursMinutes(aadatTuhr)} are istihaza, then the next ${daysHoursMinutes(newAadatHaiz)} are haiz. <br>${tab} Aadat is now ${daysHoursMinutes(aadatTuhr)} tuhur, ${daysHoursMinutes(newAadatHaiz)} haiz.`;
	 					}else{
	 						line3 = `then the next ${daysHoursMinutes(newIstihazaAfter)} are istihaza.`;

	 					}
	 					outputStringHukmLine = `${outputStringHukmLine}${line2}${line3}<br>`;

 					}else{
	 					outputStringHukmLine = `${outputStringHukmLine}, the next ${daysHoursMinutes(haz)} are haiz, and the last ${daysHoursMinutes(istihazaAfter)} are istihaza.<br>`;
 					}
 				}else{//if there is no istihaza after
 					outputStringHukmLine = `${outputStringHukmLine} and the next ${daysHoursMinutes(haz)} are haiz.<br>`;
 				}
 			}else{//there is no istihaza before, there must be istihaza after
 				if(newIstihazaAfter!=-1){//this is if it's a long istihaza. it'll either be 0, or another value.
 					outputStringHukmLine = `${outputStringHukmLine}${daysHoursMinutes(haz)} are haiz, `;

	 				var repeatingLine = `then the next ${daysHoursMinutes(aadatTuhr)} are istihaza, then the next ${daysHoursMinutes(aadatHaiz)} are haiz, `;
	 				var line2 = ``;
	 				var line3 = ``;
	 				for (var i=0; i<dividend; i++){//repeat this line the correct nmber of cycles.
	 					line2 = `${line2}${repeatingLine}`;
	 				}
	 				if(remainder>=aadatTuhr+3){
		 				 line3 = `then the next ${daysHoursMinutes(aadatTuhr)} are istihaza, then the next ${daysHoursMinutes(newAadatHaiz)} are haiz. <br>${tab} Aadat is now ${daysHoursMinutes(aadatTuhr)} tuhur, ${daysHoursMinutes(newAadatHaiz)} haiz.`;
	 				}else{
	 					line3 = `then the next ${daysHoursMinutes(newIstihazaAfter)} are istihaza.`;

	 				}
	 				outputStringHukmLine = `${outputStringHukmLine}${line2}${line3}<br>`;



 				}else{//if istihaza after isn't long
 					outputStringHukmLine = `${outputStringHukmLine}${daysHoursMinutes(haz)} are haiz, and the last ${daysHoursMinutes(istihazaAfter)} are istihaza.<br>`;

 				}
 			}

 			var outputStringAadatLine = `${tab}Aadat: ${daysHoursMinutes(aadatHaiz)}/${daysHoursMinutes(aadatTuhr)} <br>`;
  			outputString = `${outputStringTitleLine}${outputStringAadatLine}${outputStringHukmLine} <br>`

 			//write hukm in dates
 			if (startDateForQuestion != -1){//there is a date in this question
 				var startTimeOfIstihazaBefore = startTimeOfCurrentPeriod;
 				var endTimeOfIstihazaBefore = addTimeToDate(startTimeOfCurrentPeriod, istihazaBefore);
 				var startTimeOfHaz = endTimeOfIstihazaBefore;
 				var endTimeOfHaz = addTimeToDate(startTimeOfHaz, haz);
 				var startTimeOfIstihazaAfter = endTimeOfHaz;
 				var endTimeOfIstihazaAfter = addTimeToDate(startTimeOfIstihazaAfter, istihazaAfter);

 				var askAgainLine = createAskAgainLineForDamBiggerThan10(startTimeOfCurrentPeriod,gp,hz,startTimeOfHaz, endTimeOfHaz, endTimeOfIstihazaAfter, aadatTuhr, qism);
 				
 				var istihazaBeforeLine = `${tab}From ${formatDateTime(startTimeOfIstihazaBefore)} to ${formatDateTime(endTimeOfIstihazaBefore)} is istihaza, yaqeeni paki. If you didn't pray namaz or keep roza in these dates, due to the assumption of haiz, you must repeat these namaz and rozas.<br>`;

 				var hazLine = `${tab}From ${formatDateTime(startTimeOfHaz)} to ${formatDateTime(endTimeOfHaz)} are your haiz dates. Any prayers or fasts in this time are null and void.<br>`;

 				var istihazaAfterLine = ``;

 				if(newIstihazaAfter!=-1){//there is a super long period
 					var sTOfIstihaza = startTimeOfIstihazaAfter;
 					var eTOfIstihaza;
 					var sTOfHaz;
 					var eTOfHaz;

 					var dateLine = ``;

 					for (var i=0; i<dividend; i++){//the right number of cycles
 						eTOfIstihaza = addTimeToDate(sTOfIstihaza, aadatTuhr);
 						sTOfHaz = eTOfIstihaza;
 						eTOfHaz = addTimeToDate(sTOfHaz, aadatHaiz);
 						dateLine = `${dateLine}${tab}From ${formatDateTime(sTOfIstihaza)} to ${formatDateTime(eTOfIstihaza)} is istihaza, yaqeeni paki.<br>
 							${tab}From ${formatDateTime(sTOfHaz)} to ${formatDateTime(eTOfHaz)} is haiz.<br> `;
 						sTOfIstihaza = eTOfHaz;
 					}
 					//deal with remainder
 					if(remainder>=aadatTuhr+3){//ends in haiz
 						eTOfIstihaza = addTimeToDate(sTOfIstihaza, aadatTuhr);
 						sTOfHaz = eTOfIstihaza;
 						dateLine = `${dateLine}${tab}From ${formatDateTime(sTOfIstihaza)} to ${formatDateTime(eTOfIstihaza)} is istihaza, yaqeeni paki.<br>
 							${tab}From ${formatDateTime(sTOfHaz)} to ${formatDateTime(endTimeOfIstihazaAfter)} is haiz.<br> 
 							${tab}Aadat is now ${daysHoursMinutes(newAadatHaiz)} haiz and ${daysHoursMinutes(aadatTuhr)} tuhur.<br>`;

 					}else{//ends in thur
 						dateLine = `${dateLine}${tab}From ${formatDateTime(sTOfIstihaza)} to ${formatDateTime(endTimeOfIstihazaAfter)} is istihaza, yaqeeni paki.<br>`;
 					}
 					istihazaAfterLine = dateLine;



 				}else{//there is no super long period
 					istihazaAfterLine = `${tab}From ${formatDateTime(startTimeOfIstihazaAfter)} to ${formatDateTime(endTimeOfIstihazaAfter)} is istihaza, yaqeeni paki. Any namaz or roza kept in this time before ghusul was performed must be repeated. Any namaz or roza missed in this time due to the assumption of haz must be repeated.<br>`;

 				}


 				var outputStringInDates = ``;
 			
 				if(istihazaBefore>0){//if there is istihaza before
 					outputStringInDates = `${istihazaBeforeLine}${hazLine}`;
 					if(istihazaAfter>0){//if there is istihaza after as well
 						outputStringInDates = `${outputStringInDates}${istihazaAfterLine}`;
 					}
 				}else{//there is no istihaza before, there must be istihaza after
 					outputStringInDates = `${hazLine}${istihazaAfterLine}`;
 				}



 			}
 			var output = [];
 			output[0] = outputString;
 			output[1] = outputStringInDates;
 			output[2] = askAgainLine;

 			return(output);							
 		}

 		function solveLongIstihaza(istihazaAfter, aadatHaiz,aadatTuhr){
 			var dividend = Math.floor(istihazaAfter/(aadatHaiz+aadatTuhr));//how many complete cycles of tuhr followed by haiz
 			var remainder = istihazaAfter % (aadatHaiz+aadatTuhr);//incomplete leftover after that
 			var newAadatHaiz = aadatHaiz;
 			var newIstihazaAfter = remainder;
 			if (remainder >= aadatTuhr+3){//it ends in haiz
 				newAadatHaiz=remainder-aadatTuhr; //the haiz aadat changes
 				newIstihazaAfter = 0; // there is no istihaza after it
 			}else{//it ends in tuhr

 			}
 			var output = [dividend, remainder, newAadatHaiz, newIstihazaAfter];
 			return(output);
 		}

 		function printAnswerToNifaasBiggerThanForty(dividend,remainder,newAadatHaiz,newIstihazaAfter,aadatNifaas, aadatHaiz, aadatTuhr, istihazaAfter){
 			var outputStringHukmLine = `${tab}Starting from birth, the first ${daysHoursMinutes(aadatNifaas)} are nifaas, `;

 			if(newIstihazaAfter!=-1){//this is if it's a long istihaza. it'll either be 0, or another value.
	 			var repeatingLine = `then the next ${daysHoursMinutes(aadatTuhr)} are istihaza, then the next ${daysHoursMinutes(aadatHaiz)} are haiz, `;
	 			var line2 = ``;
				var line3 = ``;
	 			for (var i=0; i<dividend; i++){//repeat this line the correct nmber of cycles.
	 				line2 = `${line2}${repeatingLine}`;
	 			}
	 			if(remainder>=aadatTuhr+3){
	 				 line3 = `then the next ${daysHoursMinutes(aadatTuhr)} are istihaza, then the next ${daysHoursMinutes(newAadatHaiz)} are haiz.`;
	 			}else{
	 				line3 = `then the next ${daysHoursMinutes(newIstihazaAfter)} are istihaza.`;

	 			}
	 			outputStringHukmLine = `${outputStringHukmLine}${line2}${line3}<br>`;
			}else{//it isn't a long istihaza
	 			outputStringHukmLine = `${outputStringHukmLine}then the remaining ${daysHoursMinutes(istihazaAfter)} are istihaza.`;

	 		}
	 		//aadat line
	 		if (newAadatHaiz!=-1){
			 	outputStringHukmLine = `${outputStringHukmLine}<br>${tab} Aadat is now ${daysHoursMinutes(aadatNifaas)} nifaas, ${daysHoursMinutes(aadatTuhr)} tuhur, ${daysHoursMinutes(newAadatHaiz)} haiz.<br>`;
 			}else{
 				outputStringHukmLine = `${outputStringHukmLine}<br>${tab} Aadat is now ${daysHoursMinutes(aadatNifaas)} nifaas, ${daysHoursMinutes(aadatTuhr)} tuhur, ${daysHoursMinutes(aadatHaiz)} haiz.<br>`;
	 		}
 			return(outputStringHukmLine);
 		}


 		function dealWithBiggerThanFortyNifas(fixedPeriods){
 			//This is supposed to do 2 things - return haztuhr array, and put solution text in fixed periods
 			var hazTuhrArray = copy(fixedPeriods);
 			var aadatNifaas = -1;
 			if(givenAadatOfNifaas>-1){
 				aadatNifaas = Number(givenAadatOfNifaas);
 			}else{
 				aadatNifaas = -1;
 				return;//can't do anything here without aadat.
 			}
			var aadatHaiz = -1;
			var aadatTuhr = -1;

			if(givenAadatOfTuhr > -1){
				aadatTuhr = Number(givenAadatOfTuhr);
			}
			else{
				return;
			}
			if(givenAadatOfHaiz > -1){
				aadatHaiz = Number(givenAadatOfHaiz);
			}else{
				return;
			}

 			//we don't have to go to the trouble of finding the nifaas period. it is the first one.
 			var nifaasPeriod = hazTuhrArray[0];
 			var damInMuddateNifaas = nifaasPeriod[0];

 			//first change the length of nifaas period to aadat. mark extra after as istihazaAfter
 			var istihazaAfter = nifaasPeriod[0]-aadatNifaas;
 			nifaasPeriod[0] = aadatNifaas;

 			var dividend = -1;
 			var remainder = -1;
 			var newAadatHaiz = -1;
 			var newIstihazaAfter = -1;

 			if(istihazaAfter>aadatTuhr+3){//if we have a period that extends to the next aadat
 				var output = solveLongIstihaza(istihazaAfter, aadatHaiz,aadatTuhr);
 				dividend = output[0];
 				remainder = output[1];
 				newAadatHaiz = output[2];
 				newIstihazaAfter = output[3];
 			}

 			var answerToNifaasBiggerThanForty = printAnswerToNifaasBiggerThanForty(dividend,remainder,newAadatHaiz,newIstihazaAfter,aadatNifaas, aadatHaiz, aadatTuhr, istihazaAfter);
 			var currentPeriodOfFP = fixedPeriods[0];
			currentPeriodOfFP.push(answerToNifaasBiggerThanForty);
			fixedPeriods[0] = currentPeriodOfFP;





 			var i = 0; //i is the counter for haztuhrArray
 			var k = 0; //k is the counter for fixed periods array

 			//if it's not an extremely long periods here
 			if (remainder==-1){
 				//add it's amount to tuhur in front of it
 				if (i < hazTuhrArray.length-1){//there is a paki in front of it. 

 					var nextPeriodFP = fixedPeriods[k+1];
 			
 					var outputString = `${tab}${nextPeriodFP[0]} + ${istihazaAfter} istihaza = ${nextPeriodFP[0]+istihazaAfter} tuhr-e-faasid<br>`;
 					nextPeriodFP.push(outputString);


 					fixedPeriods[k+1] = nextPeriodFP;

 					var nextPeriod=hazTuhrArray[i+1];

 					nextPeriod[0] = nextPeriod[0] + istihazaAfter; //add istihaza to it
 					nextPeriod[1] = 3;//mark it as tuhr faasid

 					hazTuhrArray[i+1] = nextPeriod;



 				}else{//there is no paki in front of it
 					//create a new period
 					var nextPeriod = [istihazaAfter, 3];
 					hazTuhrArray.push(nextPeriod);
 					//move hazthurarray one up
 					i=i+1;
 				}
 			}else{//it is an extremely long period
 				//add the dividend number of periods of haz and tuhur

 				//add periods of haz and tuhur for the daur time in haztuhurarray
 				for (var j=0; j<dividend; j++){//add the right number of cycles
 					var nextTuhrPeriod = [aadatTuhr, 3];
 					var nextHaizPeriod = [aadatHaiz, 0];
 					hazTuhrArray.splice(i+1,0,nextTuhrPeriod,nextHaizPeriod);
 					//move i forward with each
 					i = i+2;
 				}

 				//now deal with remainder
 				if(remainder>=aadatTuhr+3){//ends in tuhr + haiz
 					var nextTuhrPeriod = [aadatTuhr, 3];
 					var nextHaizPeriod = [newAadatHaiz, 0];
 					hazTuhrArray.splice(i+1,0,nextTuhrPeriod,nextHaizPeriod);
 					i = i+2;
 					//as aadat of haiz changes, let's do that now
 					aadatHaiz = newAadatHaiz;


 				}else{//remainder ends in tuhur
 					//add amount of newIstihazafter to the next period mark it as fasid.
 					if(newIstihazaAfter>0){
 						if (i < hazTuhrArray.length-1){//there is a paki in front of it. 

 							var nextPeriodFP = fixedPeriods[k+1];
 						
 							var outputString = `${tab}${nextPeriodFP[0]} + ${daysHoursMinutes(newIstihazaAfter)} istihaza = ${nextPeriodFP[0]+newIstihazaAfter} tuhr-e-faasid<br>`;
 							nextPeriodFP.push(outputString);


 							fixedPeriods[k+1] = nextPeriodFP;

 							var nextPeriod=hazTuhrArray[i+1];

 							nextPeriod[0] = nextPeriod[0] + newIstihazaAfter; //add istihaza to it
 							nextPeriod[1] = 3;//mark it as tuhr faasid

 							hazTuhrArray[i+1] = nextPeriod;



 						}else{//there is no paki in front of it
 							//create a new period
 							var nextPeriod = [newIstihazaAfter, 3];
 							hazTuhrArray.push(nextPeriod);
 							//move i one forward
 							i=i+1;
 						}
 					}else{
 						//if it is zero, then it ends at the exact moment of aadat, I guess. we do nothing.
 					}									
 				}
 			}

 			return(hazTuhrArray);

 		}

 		function dealWithBiggerThanTenDam(fixedPeriods){
 			//This returns the hazTuhurArray. It also pushes solution text into fixedperiods array


 			//create a copy of fixed periods. don't mess with the original
 			var hazTuhrArray = copy(fixedPeriods);

			var aadatHaiz = -1;
			var aadatTuhr = -1;

			if(givenAadatOfTuhr > -1){
				aadatTuhr = givenAadatOfTuhr;
			}
			if(givenAadatOfHaiz > -1){
				aadatHaiz = givenAadatOfHaiz;
			}

			var startTimeOfCurrentPeriod = 0;

			var k = 1;


			for (var i = 1; i < hazTuhrArray.length; i++) {
				//i is the count of haztuhurarray
				//k is the count of fixed periods.


				//go through all the periods

				var currentPeriod = hazTuhrArray[i];
				var previousPeriod = hazTuhrArray[i-1];

				//if there is a starting date
				//let's just get it from k, each time,
				if(startDateForQuestion != -1){
					var previousPeriodofFP = fixedPeriods[k-1];
					if (startTimeOfCurrentPeriod == 0){
						startTimeOfCurrentPeriod = startDateForQuestion;
					}

					startTimeOfCurrentPeriod= addTimeToDate(startTimeOfCurrentPeriod, previousPeriodofFP[0]);
				}

				//if we pass by a correct haz or tuhur, make it aadat
				if (currentPeriod[0]<=10 && currentPeriod[0] >= 3 && currentPeriod[1] == 0){//if we pass by a correct haz (that ain't istimrar), put it in aadat
					aadatHaiz = currentPeriod[0];
					if (previousPeriod[1] == 1){//aadat tuhr must be the last tuhr-e sahih followed by a haiz of less than 10. This is important because it differentiates between tuhr-e-sahih and faasid
						aadatTuhr = previousPeriod[0];
					}
				}

				if (currentPeriod[0]>10 && currentPeriod[1] == 0){ // if we pass by dam bigger than 10)
					if (aadatTuhr == -1 || aadatHaiz == -1){//if there is no aadat, we can't solve this. need more info
						break;
					}else{//we have both aadaat
						var mp = previousPeriod[0];
						var gp = aadatTuhr;
						var dm = currentPeriod[0]; //in istimrar, this would be 0
						var hz = aadatHaiz;

						if (dm==0){//in istimrar, assume that dm is a long one.
							dm=aadatHaiz+aadatTuhr;
						}


						var result = solveDmBiggerThanTen(mp,gp,dm,hz);

						var qism = "";
						if (result[4] == 1){
							qism="A-1";
						}else if (result[4] == 2){
							qism="A-2";
						}else if (result[4] == 3){
							qism="A-3";							
						}else if (result[4] == 5){
							qism="B-2";
						}else if (result[4] == 6){
							qism="B-3";
						}

						var istihazaBefore = result[0];
						var haz = result[1];
						var istihazaAfter = result[2];

						aadatHaiz = Number(haz); //update aadat of haiz
						if (result[3] == 1 && previousPeriod[1] == 1){//aadat of tuhr is changing, but only if mp is not faasid
							aadatTuhr = mp;//aadatTuhr was gp, only changes to mp if not faasid
						}


						var dividend = -1;
						var remainder = -1;
						var newAadatHaiz = -1;
						var newIstihazaAfter = -1;

						if(istihazaAfter>aadatTuhr+3){//if we have a period that extends to the next aadat
							var output = solveLongIstihaza(istihazaAfter, aadatHaiz,aadatTuhr);
							dividend = output[0];
							remainder = output[1];
							newAadatHaiz = output[2];
							newIstihazaAfter = output[3];
						}

						var answerToStringBiggerThanTen = printAnswerToDamBiggerThan10(mp,gp,dm,hz,qism, istihazaBefore, haz, istihazaAfter, aadatTuhr, aadatHaiz, startTimeOfCurrentPeriod, dividend, remainder, newAadatHaiz, newIstihazaAfter);

						var hukmString = answerToStringBiggerThanTen[0];
						var hukmStringInDates = answerToStringBiggerThanTen[1];
						var askAgainLine = answerToStringBiggerThanTen[2];

						hukmString = `${hukmString}${hukmStringInDates}`;


						var currentPeriodOfFP = fixedPeriods[k];
						currentPeriodOfFP.push(hukmString);
						currentPeriodOfFP.push(askAgainLine);
						fixedPeriods[k] = currentPeriodOfFP;




						//add istihaza before to the previous tuhr and mark tuhr as faasid
						//if isthaza before exists!
						if(result[0]>0){
							previousPeriod[0]=previousPeriod[0]+result[0]; //result[0] is istihaza before
							previousPeriod[1]=3; //tuhr e faasid
							hazTuhrArray[i-1]=previousPeriod;
						}

						currentPeriod[0]= result[1]; //resize this period to haz
						hazTuhrArray[i] = currentPeriod;



						if (istihazaAfter>0 && currentPeriod[1] != -1){//there is an istihaza after it, and it ain't istimrar
							//if it's not an extremely long periods here
							if (remainder==-1){
								//add it's amount to tuhur in front of it
								if (i < hazTuhrArray.length-1){//there is a paki in front of it. 

									var nextPeriodFP = fixedPeriods[k+1];
		
									var outputString = `${tab}${nextPeriodFP[0]} + ${istihazaAfter} istihaza = ${nextPeriodFP[0]+istihazaAfter} tuhr-e-faasid<br>`;
									nextPeriodFP.push(outputString);


									fixedPeriods[k+1] = nextPeriodFP;

									var nextPeriod=hazTuhrArray[i+1];

									nextPeriod[0] = nextPeriod[0] + istihazaAfter; //add istihaza to it
									nextPeriod[1] = 3;//mark it as tuhr faasid

									hazTuhrArray[i+1] = nextPeriod;



								}else{//there is no paki in front of it
									//create a new period
									var nextPeriod = [istihazaAfter, 3];
									hazTuhrArray.push(nextPeriod);
									//move hazthurarray one up
									i=i+1;
								}
							}else{//it is an extremely long period
								//add the dividend number of periods of haz and tuhur

								//add periods of haz and tuhur for the daur time in haztuhurarray
								for (var j=0; j<dividend; j++){//add the right number of cycles
									var nextTuhrPeriod = [aadatTuhr, 3];
									var nextHaizPeriod = [aadatHaiz, 0];
									hazTuhrArray.splice(i+1,0,nextTuhrPeriod,nextHaizPeriod);
									//move i forward with each
									i = i+2;
								}

								//now deal with remainder
								if(remainder>=aadatTuhr+3){//ends in tuhr + haiz
									var nextTuhrPeriod = [aadatTuhr, 3];
									var nextHaizPeriod = [newAadatHaiz, 0];
									hazTuhrArray.splice(i+1,0,nextTuhrPeriod,nextHaizPeriod);
									i = i+2;
									//as aadat of haiz changes, let's do that now
									aadatHaiz = newAadatHaiz;


								}else{//remainder ends in tuhur
									//add amount of newIstihazafter to the next period mark it as fasid.
									if(newIstihazaAfter>0){
										if (i < hazTuhrArray.length-1){//there is a paki in front of it. 

											var nextPeriodFP = fixedPeriods[k+1];
										
											var outputString = `${tab}${nextPeriodFP[0]} + ${daysHoursMinutes(newIstihazaAfter)} istihaza = ${nextPeriodFP[0]+newIstihazaAfter} tuhr-e-faasid<br>`;
											nextPeriodFP.push(outputString);


											fixedPeriods[k+1] = nextPeriodFP;

											var nextPeriod=hazTuhrArray[i+1];

											nextPeriod[0] = nextPeriod[0] + newIstihazaAfter; //add istihaza to it
											nextPeriod[1] = 3;//mark it as tuhr faasid

											hazTuhrArray[i+1] = nextPeriod;



										}else{//there is no paki in front of it
											//create a new period
											var nextPeriod = [newIstihazaAfter, 3];
											hazTuhrArray.push(nextPeriod);
											//move i one forward
											i=i+1;
										}
									}else{
										//if it is zero, then it ends at the exact moment of aadat, I guess. we do nothing.
									}									
								}
							}
						}

					}
				}

				//if the current period says istmrar on it.
				//Should we even make a seperate one for this?
				//yes
				if (currentPeriod[0] == -1 && currentPeriod[1] == 0){
					if (aadatTuhr == -1 || aadatHaiz == -1){//if there is no aadat, we can't solve this. need more info
						break;
					}else{//we have both aadaat
						var mp = previousPeriod[0];
						var gp = aadatTuhr;
						var hz = aadatHaiz;
						//no dm, because that is istimrar
						var result = solveIstimrar(mp,gp,hz);

						var qism = "";
						if (result[3] == 1){
							qism="A-1";
						}else if (result[3] == 5){
							qism="B-2";
						}else if (result[3] == 6){
							qism="B-3";
						}

						var istihazaBefore = result[0];
						var haz = result[1];

						aadatHaiz = haz; //update aadat of haiz
						if (result[2] == 1 && previousPeriod[1] == 1){//aadat of tuhr is changing, but only if mp is not faasid
							aadatTuhr = mp;//aadatTuhr was gp, only changes to mp if not faasid
						}

						var answerToStringBiggerThanTen = printAnswerToIstimrar(mp,gp,hz,qism, istihazaBefore, haz, aadatTuhr, aadatHaiz, startTimeOfCurrentPeriod);

						var currentPeriodOfFP = fixedPeriods[i];
						currentPeriodOfFP.push(answerToStringBiggerThanTen);
						fixedPeriods[i] = currentPeriodOfFP;
					}
				}
				//iterate k (count of fixed periods)

				k=k+1;
				if (k>=fixedPeriods.length){
					//this should not happen except at the end of the periods.
					break;
				}

			}
 
 			return(hazTuhrArray); 			
 		}

 		function fixPeriodsArrayN(){
			//create a copy of periods array. don't mess with the original
			var fixedPeriods = copy(periods);
			//add positions as fixedPeriods[2]
			for (var i=0; i<fixedPeriods.length; i++){
				var currentPeriod = [];
				var positions = [i]; 
				//Why is this an array? check later
				//because we often store more than one position.

				currentPeriod = fixedPeriods[i];
				currentPeriod.push(positions);
				fixedPeriods[i] = currentPeriod;
			}

			//Step 0 : Join Muttasil periods of the same type
			//Let it do this to clean up clutter
			fixedPeriods = joinMuttasilPeriods(fixedPeriods);

			//Step 1: Go through all the periods. mark all tuhurs of less than 15 days, surrounded by dam on either side, as dam
			//And even this
			fixedPeriods = removeTuhrENaaqis(fixedPeriods);



			//Step 2: Add up all dam in muddat-e-nifaas.

			var damInMuddateNifaas = 0;

			for (var i = 0; i < fixedPeriods.length; i++) {
				var currentPeriod = fixedPeriods[i];
//				var nextPeriod = fixedPeriods[(i+1)];

//				var previousPeriod = fixedPeriods[i-1];

				if (currentPeriod[0] > -1){//if it is not istimrar, add em all up, dams and tuhurs
					// if(i==1){
					// 	damInMuddateNifaas = damInMuddateNifaas + currentPeriod[0] + previousPeriod[0];
					// }
					damInMuddateNifaas = damInMuddateNifaas + currentPeriod[0];
					if (damInMuddateNifaas > 40){
						if (currentPeriod[1] == 1 && i>=1){//if it ended at a tuhur (which must be tamm, as we've eliminated naqis), and there was a period before this
							var previousPeriod = fixedPeriods[i-1];
							damInMuddateNifaas = damInMuddateNifaas - currentPeriod[0];

							//announce a new aadat for nifas
							var nifaasAadat = damInMuddateNifaas;

							//remove this amount from fixed periods
							//actually, probably we should leave it in fixed periods, just mark it's type as nifaas.

							//first make it all muttasil.

							previousPeriod[0] = damInMuddateNifaas;//increase length of last period
							previousPeriod[1] = 4; //type 4 will be nifas


							for (var j=0; j<i-1; j++){//delete all previous periods
								//store position of first period in previous period
								var firstPeriod = fixedPeriods[0];
								previousPeriod[2] = previousPeriod[2].concat(firstPeriod[2]);
								//delete first period
								fixedPeriods.shift();
							}

						}else{//if it ended at a dam
							//first make it all muttasil.

							currentPeriod[0] = damInMuddateNifaas;//increase length of current period
							currentPeriod[1] = 4; //type 4 will be nifas


							for (var j=0; j<i; j++){//delete all previous periods
								//store position of first period in current period
								var firstPeriod = fixedPeriods[0];
								currentPeriod[2] = currentPeriod[2].concat(firstPeriod[2]);
								//delete first period
								fixedPeriods.shift();
							}
							//get aadat of nifaas. 
							if(givenAadatOfNifaas!=-1){//if we have an aadat of nifas
								var hazTuhrArray = dealWithBiggerThanFortyNifas(fixedPeriods);

							}else{//if aadat didn;t exist
								currentPeriod.push("Aadat is needed");
								fixedPeriods[0] = currentPeriod;
								return(fixedPeriods);//this is equivalent to break
							}
						}
						//run periods on the remaing bit.

						//Step 2: Go through all periods. add all dam of less than 3 days, surrounded by tuhur, into tuhurs on either side. mark tuhurs as faasid.
						//this should be safe as there shouldn't be any left from nifas
						fixedPeriods = removeDamLessThanThree(fixedPeriods);


						//Step 3: Go through them all in order, fixing each period longer than 10, on the way, including istimrar.
						// this should also be fine, as it deals with type 0, and nifas is type 4
						var hazTuhrArray = dealWithBiggerThanTenDam(fixedPeriods);
						break;

					}else if(i==fixedPeriods.length-1){//dam is less than 40, but this is the last period we have
						if(currentPeriod[1] == 1){//if the last thing was a tuhr
							//make everything before it nifaas
							if(i>0){//if there is a previous period
								var previousPeriod = fixedPeriods[i-1];
								damInMuddateNifaas = damInMuddateNifaas - currentPeriod[0];

								//announce a new aadat for nifas
								var aadatNifaas = damInMuddateNifaas;

								//remove this amount from fixed periods
								//actually, probably we should leave it in fixed periods, just mark it's type as nifaas.

								//first make it all muttasil.

								previousPeriod[0] = damInMuddateNifaas;//increase length of last period
								previousPeriod[1] = 4; //type 4 will be nifas


								for (var j=0; j<i-1; j++){//delete all previous periods
									//store position of first period in previous period
									var firstPeriod = fixedPeriods[0];
									previousPeriod[2] = previousPeriod[2].concat(firstPeriod[2]);
									//delete first period
									fixedPeriods.shift();
								}

							}

						}else{//last thing was dam
							//first make it all muttasil.
							currentPeriod[0] = damInMuddateNifaas;//increase length of last period
							currentPeriod[1] = 4; //type 4 will be nifas

							for (var j=0; j<i; j++){//delete all previous periods
								//store position of first period in current period
								var firstPeriod = fixedPeriods[0];
								currentPeriod[2] = currentPeriod[2].concat(firstPeriod[2]);
								//delete first period
								fixedPeriods.shift();
							}
						}
					}
				}
			}
			return(fixedPeriods);
		}



		function fixPeriodsArray(){
			//create a copy of periods array. don't mess with the original
			var fixedPeriods = copy(periods);
			//add positions as fixedPeriods[2]
			for (var i=0; i<fixedPeriods.length; i++){
				var currentPeriod = [];
				var positions = [i];

				//Why is this an array? check later
				//because we often store more than one position.


				currentPeriod = fixedPeriods[i];
				currentPeriod.push(positions);
				fixedPeriods[i] = currentPeriod;
			}

			//Step 0 : Join Muttasil periods of the same type
			fixedPeriods = joinMuttasilPeriods(fixedPeriods);

			//Step 1: Go through all the periods. mark all tuhurs of less than 15 days, surrounded by dam on either side, as dam
			fixedPeriods = removeTuhrENaaqis(fixedPeriods);

			//Step 2: Go through all periods. add all dam of less than 3 days, surrounded by tuhur, into tuhurs on either side. mark tuhurs as faasid.
			fixedPeriods = removeDamLessThanThree(fixedPeriods);


			//Step 3: Go through them all in order, fixing each period longer than 10, on the way, including istimrar.
			var hazTuhrArray = dealWithBiggerThanTenDam(fixedPeriods);

			return(fixedPeriods);


		}

		function solveIstimrar(mp, gp, hz){
			//dm here will be istimrar
			var answer = []; 
			var soorat = 0;
			var istihazaBefore = 0;
			var haiz = 0;
			var aadatTuhr = -1; // 0 for gp, 1 for mp

			if (mp <= gp) {    //Qism A - it will always be A-1
				soorat = 1;
				istihazaBefore = gp-mp;
				haiz = hz;
				aadatTuhr = 0;
			}else {	// mp>gp qism B
				if (hz - (mp - gp) >= 3) {							// soorat B-2
					soorat = 5;
					istihazaBefore = 0;
					haiz = hz-(mp-gp);
					aadatTuhr = 1;
				}else if (hz - (mp - gp) < 3) {						// soorat B-3
					soorat = 6;
					istihazaBefore = 0;
					haiz = hz;
					aadatTuhr = 1;
				}
			}
			answer.push(istihazaBefore); //istihaza before
			answer.push(haiz); //haiz
			answer.push(aadatTuhr); //adat of tuhr, 0 if no change gp, 1 if change, mp
			answer.push(soorat);
			return(answer);
		}

		function solveDmBiggerThanTen(mp, gp, dm, hz){
			//This function will return an array called answer
			//answer[0] will be istihaza before, if any, answer[1] will be haiz, answer [2] will be istihaza after, if any. answer [3] can be soorat. 
			//I'm putting soorat A-1 as 1, A-2 as 2, A-3 as 3, B-2 as 5 and B-3 as 6. Yes, we are skipping numbers here, but I can remember this.
			//I'm not adding aadat of haiz and tuhur in answer. aadat of haiz will always be answer[1]. aadat of tuhur depends, so will calculate aadat elsewhere.
			var answer = []; 
			var soorat = 0;
			var istihazaBefore = 0;
			var haiz = 0;
			var istihazaAfter = 0;
			var aadatTuhr = -1; // 0 for gp, 1 for mp

			if (mp <= gp) {    //Qism A
				if (hz <= dm - (gp - mp)) {	                  // soorat A-1
					// if GP==MP, we would output 0 istihaza, not good!
					// 0 istihaza is ok, for now. just no negative numbers, please
					soorat = 1;
					istihazaBefore = gp-mp;
					haiz = hz;
					istihazaAfter = dm-(gp-mp)-hz;
					aadatTuhr = 0;
				}
				else if (3 <= dm-(gp-mp) && dm-(gp-mp) < hz) {  // soorat A-2
					soorat = 2;
					istihazaBefore = gp-mp;
					haiz = dm-(gp-mp);
					istihazaAfter = 0;
					aadatTuhr = 0;
				}
				else if (dm - (gp - mp) < 3) {                  // soorat A-3
					soorat = 3;
					istihazaBefore = 0;
					haiz = hz;
					istihazaAfter = dm-hz;
					aadatTuhr = 1;
				}
			}else {	// mp>gp qism B
				if (hz - (mp - gp) >= 3) {							// soorat B-2
					soorat = 5;
					istihazaBefore = 0;
					haiz = hz-(mp-gp);
					istihazaAfter = dm-(hz-(mp-gp));
					aadatTuhr = 1;
				}else if (hz - (mp - gp) < 3) {						// soorat B-3
					soorat = 6;
					istihazaBefore = 0;
					haiz = hz;
					istihazaAfter = dm-hz;
					aadatTuhr = 1;
				}
			}
			answer.push(istihazaBefore); //result[0] is istihaza before
			answer.push(haiz); //result[1] is haiz
			answer.push(istihazaAfter) //result[2] is istihaza after
			answer.push(aadatTuhr); //result[3] is adat of tuhr, 0 if no change gp, 1 if change, mp
			answer.push(soorat);//result[4] is soorat; 1 is A1, 2 is A2, 3 is A3, 5 is B2, 6 is B3
			return(answer);
		}

		function roundToNearestTenth(value){
			return(Math.round(value * 10) / 10);
		}

		function getValuesOfPositions(positionsArray){
			var stringOfSums = "";
			if(positionsArray.length>1){
				var sumOfString = 0;
				//sort positions array in increasing order
				positionsArray.sort(function(a, b){return a - b});
				//get values for positions array
				for(var i=0; i<positionsArray.length; i++){
					var periodAtPosition = periods[positionsArray[i]];
					var valueOfPosition = periodAtPosition[0];

					if (valueOfPosition == -1){
						sumOfString = "istimrar";
						stringOfSums = `${stringOfSums} + istimrar`;

					}else{
						sumOfString = sumOfString+valueOfPosition;
						stringOfSums= `${stringOfSums} + ${daysHoursMinutes(valueOfPosition)}`;
					}
				}
				if(stringOfSums.startsWith(" + ")){
					stringOfSums=stringOfSums.substring(3);
				}

				if (sumOfString!="istimrar"){
					stringOfSums = `${tab}(${stringOfSums} = ${daysHoursMinutes(sumOfString)}) <br>`;
				}else{
					stringOfSums = `${tab}(${stringOfSums} = ${sumOfString}) <br>`;
				}

			}

			return(stringOfSums);
		}


		function printPeriodsArray(fixedPeriods){
			var periodsoutput = "Solution: <br>";
			for (var i = 0; i < fixedPeriods.length; i++) {
				var period = fixedPeriods[i];
				//period[0] is duration
				//period[1] is type
				//istimrar is duration -1, type dam 0
				//spot is duration 0, type dam 0
				//spotting is regular dam 0
				//period[2] contains positions info which helps generate the string of sums
				//type 4 is nifaas
				if (period[1]==1){//tuhur
					periodsoutput = `${periodsoutput} <b>${daysHoursMinutes(period[0])} tuhur</b> <br>`;


				}else if(period[1]==0){//dam
					if (period[0]==0){//single spot
						periodsoutput = `${periodsoutput} <b>spot</b> <br>`;


					}else if(period[0]==-1){//istimrar
						periodsoutput = `${periodsoutput} <b>istimrar</b> <br>`;
					}else{
						periodsoutput = `${periodsoutput} <b>${daysHoursMinutes(period[0])} dam</b> <br>`;
					}

				}else if(period[1]==3){//tuhure faasid
					periodsoutput = `${periodsoutput} <b>${daysHoursMinutes(period[0])} tuhur e faasid</b> <br>`;
				}else if(period[1]==4){//nifaas
					periodsoutput = `${periodsoutput} <b>${daysHoursMinutes(period[0])} nifaas</b> <br>`;

				}

				var positionsArray = period[2];
				var stringOfSums = getValuesOfPositions(positionsArray);
				if (stringOfSums!=""){
					periodsoutput = `${periodsoutput} ${stringOfSums}`;
				}
				var checkNextTuhur;
				//until now, periods output contains the bolded line under solution, and a string of sums under it, if necessary.

				//period[3] contains the solution, in duration, and in dates, if there are dates
				//period[4] contains ask again line, only to be inclded after the last entry


				if(period[1]==0 && period[0]>10){ //for period bigger than 10
					if(period.length>3){//if there is a solution (if no adat, there wouldn't be)
						periodsoutput = `${periodsoutput}${period[3]}`;
						checkNextTuhur = 1;
					}
				}
				if(checkNextTuhur==1 && (period[1]==1 || period[1]==3)){//if there is a solution, there is a chance that tuhur after that will have added istihaza line, so check for that,
					checkNextTuhur = 0;
					if(period.length>=4){
						periodsoutput = `${periodsoutput}${period[3]}`;
					}
				}
				if(period[1]==0 && period [0]==-1){ //for istimrar
					if(period.length>3){//if there is a solution (if no adat, there wouldn't be)
						periodsoutput = `${periodsoutput}${period[3]}`;
					}
				}
				if(period[1]==4 && period.length>3){//for nifas
					periodsoutput = `${periodsoutput}${period[3]}`;
					checkNextTuhur = 1;
				}
				if(i == fixedPeriods.length-1 && period.length>=5){//if this is the last period and there is an askagainLine(period[4])
					periodsoutput = `${periodsoutput}<br>&nbsp;<br>${period[4]}`;

				}

			}
			return(periodsoutput);

		}

		function printValues(value,t){
			if (t == 0){//dam
				if (value == -1){//checking for istimrar
					textToPrint=`${textToPrint} &rarr; istimrar`;
				}else{
					textToPrint=`${textToPrint} &rarr; ${daysHoursMinutes(value)} dam`;
				}


			}else if (t == 1){//tuhur
				textToPrint=`${textToPrint} &rarr; ${daysHoursMinutes(value)} tuhur`;

			}else{//spot
				if (value == 0){//just a dhabba
					textToPrint=`${textToPrint} &rarr; a spot`;

				}else{
					textToPrint=`${textToPrint} &rarr; ${daysHoursMinutes(value)} of spotting`;

				}

			}
			if (textToPrint.slice(0,8)== " &rarr; ") {//if it starts with an arrow, remove it
				textToPrint=textToPrint.slice(8);
			}
			return(textToPrint);

		}

		function compareTwoHazTuhurArrays(haztuhur1, haztuhur2){
			//not used yet, intended for zallah kay masail


			//let's assume that the 2 arrays are a series of dates, the first thing in each array is the starttime of haz, the second one is the endtime, and so on.

			var combinedArray = [];
	
			for(var i=0; i<haztuhur1.length; i++){
				var date = haztuhur1[i];
				var evenOdd = i % 2; //if even is 0, it's even, 1, it's odd
				var array = [];
				if (evenOdd == 0){
					array = [date, "S1"];
				}else{
					array = [date, "E1"];
				}
				combinedArray.push(array);
			}
			for(var i=0; i<haztuhur2.length; i++){
				var date = haztuhur2[i];
				var evenOdd = i % 2; //if even is 0, it's even, 1, it's odd
				var array = [];
				if (evenOdd == 0){
					array = [date, "S2"];
				}else{
					array = [date, "E2"];
				}
				combinedArray.push(array);
			}

			//this line ought to sort the array by date
			combinedArray.sort(function(a, b){return a[0] - b[0]});

			var outputString = ``;
			//this loop ought to step through all the values, adding and subtracting counter as it goes.
			for (var i=0; i<combinedArray.length; i++){
				var currentArray = combinedArray[i];
				var counter = 0;
				if (currentArray[1] == "S1" || currentArray[1] == "S2"){
					counter = counter + 1;
				}else if (currentArray[1] == "E1" || currentArray[1] == "E2"){
					counter = counter - 1;
				}
				//counter at 0 means both paki
				//counter at 1 means one haz, one tuhur
				//counter at 2 means both haz

				if(i>0){//there is a previous value
					var previousArray = combinedArray[i-1];
					if (previousArray[0]!=currentArray[0]){//there is no point to a from/to, if the 2 values are identical
						if(counter == 1 && i >0){//ayyam-e-shakk
							outputString = `${outputString}From ${previousArray[0]} to ${currentArray[0]} are ayyam-e-shakk<br>`;
						}else if(counter == 0 && i > 0){//paki
							outputString = `${outputString}From ${previousArray[0]} to ${currentArray[0]} are yaqeeni paki<br>`;
						}else if(counter == 2 && i > 0){//haz
							outputString = `${outputString}From ${previousArray[0]} to ${currentArray[0]} are yaqeeni haiz<br>`;
						}

					}
				}

			}
			return (outputString);
		}


		function resetDimaAthaar(){
			textToPrint = "";
			givenAadatOfHaiz = -1;
			givenAadatOfTuhr = -1;
			periods.splice(0,periods.length);
			gid("solution").innerHTML = `${textToPrint}`;
			gid("hall").innerHTML = ``;
			gid("numberofdays").value=`0`;
			gid("submitButton").disabled=false;

		}
		var dates = "";
		var startDateForQuestion = -1;

		function submitMS(){
			//get values of Mashqi Sawal
			var startTime = gid("strtTimeMS").value;
			var endTime = gid("endTimeMS").value;

			if (startDateForQuestion == -1){//store the first value for this question.
				startDateForQuestion = startTime;
			}


			var value = calculateDurationInDays(startTime,endTime);

			var type = 5;//5 is not a type if it turns up 5, there's an error


			function calculateDurationInDays(st, et){
				var diff = Math.abs((new Date(st)- new Date(et))/60000); //This gives the diff in minutes
				var returnDays = diff/(60*24);
				// var minutes = diff % 60;
				// diff = (diff - minutes)/60; //now diff is in hours
				// var hours = diff % 24;
				// var days = (diff - hours)/24;
				// var returnString = `${days} days, ${hours} hours, ${minutes} minutes`;
				return(returnDays);
			}

			var damTuhurSpot = document.getElementsByName("damtuhurspotMS");
			for (var i = 0, length = damTuhurSpot.length; i < length; i++) {
 				 if (damTuhurSpot[i].checked) {
    				// do whatever you want with the checked radio
    				type = damTuhurSpot[i].value;

  					// only one radio can be logically checked, don't check the rest
    				break;
  				}
			}

			if (type == 3){//istimrar
				type = 0;
				value = -1;
				endTime = startTime;

				//disable all buttons
				gid("strtTimeMS").disabled = true;
				gid("endTimeMS").disabled = true;
				gid("submitButtonMS").disabled = true;

			}


			if (endTime<=startTime && type != 2 && value != -1){
				return;
			}else if (endTime<=startTime && type == 2){
				value = 0;
			}

			printDates(startTime, endTime, value, type);

			function printDates(startTime, endTime, value, type){
				startTime=formatDateTime(`${new Date(startTime)}`);
				endTime=formatDateTime(`${new Date(endTime)}`);


				var typeInString = "";
				if (type == 0 && value != -1){
					typeInString = "dam";
				}else if (type == 1){
					typeInString = "tuhur";
				}else if (type == 2){
					typeInString = "spotting";
				}

				if (type == 0 && value == -1){
					dates = `${dates}<br>Istimrar starting from ${startTime}`;
				}else{
					dates = `${dates}<br>${startTime} - ${endTime} = ${daysHoursMinutes(value)} of ${typeInString}`;
				}

				
				if (dates.slice(0,4)== "<br>") {//if it starts with a linebreak, remove it
					dates=dates.slice(4);
				}

				gid("datesMS").innerHTML = `${dates}`;
			}


			var textToPrint = printValues(value, type); //Step 1: Write all the info with arrows
			gid("solutionMS").innerHTML = `${textToPrint}`;

			if (type == 2){ //convert spots to dam
				type =0;
			}
			putValueInPeriodsArray(value,type);
			var fixedPeriods = fixPeriodsArray();
			var periodsoutput = printPeriodsArray(fixedPeriods);
			gid("hallMS").innerHTML = `${periodsoutput}`

			switchValues();//switvh value of start time and endtime


			function switchValues(){
				gid("strtTimeMS").value = gid("endTimeMS").value;
				gid("strtTimeMS").disabled = true;
			}

		}

		function resetMS(){
			textToPrint = "";
			dates = "";
			givenAadatOfHaiz = -1;
			givenAadatOfTuhr = -1;
			startDateForQuestion = -1;
			periods.splice(0,periods.length);
			gid("solutionMS").innerHTML = `${textToPrint}`;
			gid("hallMS").innerHTML = ``;
			gid("datesMS").innerHTML = ``;
			gid("aadatTextMS").innerHTML = ``;
			gid("aadatMS").value = "";
			gid("strtTimeMS").disabled = false;
			gid("endTimeMS").disabled = false;
			gid("submitButtonMS").disabled = false;
			
		}

		var givenAadatOfHaiz=-1;
		var givenAadatOfTuhr=-1;
		var givenAadatOfNifaas=-1;

		function onChangeAadatN(){
			var aadatNifaas = Number(gid("aadatNifaasN").value);
			var aadatHaiz = Number(gid("aadatHaizN").value);
			var aadatTuhur = Number(gid("aadatTuhrN").value);

			if(aadatNifaas>40||aadatNifaas==0){
				aadatNifaas = -1;
			}
			if(aadatHaiz<3 || aadatHaiz >10){
				aadatHaiz = -1;
			}
			if (aadatTuhur<15){
				aadatTuhur = -1;
			}

			var aadatTextN = `Aadat is `;
			if (aadatHaiz!=-1){
				aadatTextN = `${aadatTextN}${aadatHaiz} days haiz, `;
				givenAadatOfHaiz = aadatHaiz;

			}			
			if (aadatTuhur!=-1){
				aadatTextN = `${aadatTextN}${aadatTuhur} days tuhur, `;
				givenAadatOfTuhr = aadatTuhur;

			}

			if (aadatNifaas!=-1){
				aadatTextN = `${aadatTextN}${aadatNifaas} days nifaas, `;
				givenAadatOfNifaas = aadatNifaas;

			}
			if(aadatTextN.endsWith(", ")){
				aadatTextN= aadatTextN.slice(0, aadatTextN.length-2);
			}
			if(aadatNifaas==-1||aadatTuhur==-1||aadatHaiz==-1){
				aadatTextN = `Aadat is incorrect`;
			}

			gid("aadatTextN").innerHTML = aadatTextN;

			//trigger calculate
			 var fixedPeriods = fixPeriodsArrayN();
			 var periodsoutput = printPeriodsArray(fixedPeriods);
			 gid("hallMS").innerHTML = `${periodsoutput}`;

		}



		function onChangeAadat(){
			var aadatText = gid("aadatMS").value;
			var aadatHaiz = -1;
			var aadatTuhur = -1;
			while (aadatText.startsWith(" ")){//slice trailing spaces before
				aadatText.slice(0,1);
			}

			while (aadatText.endsWith(" ")){
				aadatText.slice(aadatText.length,aadatText.length+1);	//slice trailing spaces after
			}

			if (aadatText.includes("/") ){
				var aadatOne = aadatText.slice(0,aadatText.indexOf("/"));
				var aadatTwo = aadatText.slice(aadatText.indexOf("/")+1, aadatText.length+1);
				if(aadatOne<=10 && aadatOne >= 3 && aadatTwo>=15){
					aadatHaiz = aadatOne;
					aadatTuhur = aadatTwo;
				}else if(aadatTwo<=10 && aadatTwo >=3 && aadatOne>=15){
					aadatHaiz = aadatTwo;
					aadatTuhur = aadatOne;
				}
			}else if (aadatText.includes("-") ){
				var aadatOne = aadatText.slice(0,aadatText.indexOf("-"));
				var aadatTwo = aadatText.slice(aadatText.indexOf("-")+1, aadatText.length+1);
				if(aadatOne<=10 && aadatOne >= 3 && aadatTwo>=15){
					aadatHaiz = aadatOne;
					aadatTuhur = aadatTwo;
				}else if(aadatTwo<=10 && aadatTwo >=3 && aadatOne>=15){
					aadatHaiz = aadatTwo;
					aadatTuhur = aadatOne;
				}

			}
			if (aadatHaiz != -1 && aadatTuhur != -1) {
				gid("aadatTextMS").innerHTML = `Aadat: ${aadatHaiz} days haiz, ${aadatTuhur} days tuhur`;
				givenAadatOfTuhr = aadatTuhur;
				givenAadatOfHaiz = aadatHaiz;
				//trigger calculate
				var fixedPeriods = fixPeriodsArray();
				var periodsoutput = printPeriodsArray(fixedPeriods);
				gid("hallMS").innerHTML = `${periodsoutput}`;

			}else{
				gid("aadatTextMS").innerHTML = `Aadat is incorrect`;
				givenAadatOfTuhr = -1;
				givenAadatOfHaiz = -1;
				//trigger calculate
				var fixedPeriods = fixPeriodsArray();
				var periodsoutput = printPeriodsArray(fixedPeriods);
				gid("hallMS").innerHTML = `${periodsoutput}`;


			}


		}

	</script>
	<!-- This is where we keep the css currently. When done we will
         move it out to the css file	-->
	<style>
		.hide { 
			display: none; 
		}
	</style>
  </head>
  <body  encoding='utf8'>
  	<p>Dimaa and At-haar</p>
  	<p>Please input dimaa and at-haar in order, starting from the earliest. To enter just a spot, put the value as 0, check spot and click submit. For several days of spotting, put the number of days in the value, check spot, and click submit. To enter istimraar, type istimrar in the value, check dam, and click submit.</p>

	<input type="text" id="numberofdays" value="0"><label for="numberofdays">Days</label><br>
	<input type="radio" id="dam1" name="damtuhurspot" value="0">
	<label for="dam1">Dam</label><br>
	<input type="radio" id="tuhur1" name="damtuhurspot" value="1">
	<label for="tuhur1">Tuhur</label><br>
	<input type="radio" id="spot1" name="damtuhurspot" value="2">
	<label for="spot1">Spot</label><br>

	<input type="button" value="Submit" id="submitButton" onclick="submitDimaAthaar()">
	<input type="button" value="Reset" onclick="resetDimaAthaar()"><br>

	<p><span id="solution"></span></p>

	<p><span id="hall"></span></p>





  	<hr/>
	<p>Duration Calculator</p>
	<table>
		<tr><td>Start time:</td><td><input type="datetime-local" id="strtTime" value="2021-03-01T00:00" onchange="calculateDuration()"></td></tr>
		<tr><td>End time:</td><td><input type="datetime-local" id="endTime" value="2021-03-20T00:00" onchange="calculateDuration()"></td></tr>
	</table>
	<p>The duration is <span id="duration"></span></p>
	
	<hr/>
	<p>Add time to date</p>
	<p>Start date and time: <input type="datetime-local" id="strtTime1" value="2021-03-01T00:00" onchange="addTime()"></p>
	<table>
		<tr><td></td><td>Days</td><td>Hours</td><td>Minutes</td></tr>
		<tr><td>Add time:</td>
			<td><input type="text" id="addTimeDays" value="1" onchange="addTime()"></td>
			<td><input type="text" id="addTimeHours" value="0" onchange="addTime()"></td>
			<td><input type="text" id="addTimeMinutes" value="0" onchange="addTime()"></td>
		</tr>
	</table>
	<p>The end time is <span id="addedTime"></span></p>
	<hr/>

	<table>
		<tr><td></td><td>Days</td><td>Hours</td><td>Minutes</td></tr>
		<tr><td>Mawjooda Paki:</td><td><input type="text" id="mpdays" value="26"></td>
			<td><input type="text" id="mphours" value="0"></td>
			<td><input type="text" id="mpminutes" value="0"></td></tr>
		<tr><td>Guzashta Paki:</td><td><input type="text" id="gpdays" value="19"></td>
			<td><input type="text" id="gphours" value="0"></td>
			<td><input type="text" id="gpminutes" value="0"></td>
		</tr>
		<tr><td>Dam:</td><td><input type="text" id="dmdays" value="14"></td>
			<td><input type="text" id="dmhours" value="0"></td>
			<td><input type="text" id="dmminutes" value="0"></td>
		</tr>
		<tr><td>Haiz:</td><td><input type="text" id="hzdays" value="6"></td>
			<td><input type="text" id="hzhours" value="0"></td>
			<td><input type="text" id="hzminutes" value="0"></td>
		</tr>
	</table>
	<!-- div is for paragraphs, while span is for portions of lines -->
	<p>Mawjooda Paki <span id="comp">&leq;</span> Guzashta Paki so Qism is <span id="AorB">A</span></p>
	<p>The difference between Guzashta Paki and Mawjooda Paki is <span id="dif"></span></p>
	<p>Because <span id="cond"></span> the Soorat is <span id="soorat"></span></p>
	<p>Hukm is that out of <span id="dam"></span> of dam:</p>
	<ul>
		<li id="hukm1">The first <span id="val1"></span> are <span id="type1"></span></li>
		<li id="hukm2" class="hide">The next  <span id="val2"></span> are <span id="type2"></span></li>
		<li id="hukm3">The last  <span id="val3"></span> are <span id="type3"></span></li>
	</ul>
	<p>The Aadat for:</p>
	<ul>
		<li>Haiz <span id="samehz"></span> <span id="valhz"></span></li>
		<li>Tuhr <span id="samegp"></span> <span id="valgp"></span></li>
	</ul>
	<p>&nbsp;</p>
	<hr>
	<p>&nbsp;</p>
	<p>Mashqi Sawal</p>
	<p>Please enter information about periods, starting with the earliest period the saailah remembers. please also enter the tuhur amounts.</p>
	<table>
		<tr><td>Start:</td><td><input type="datetime-local" id="strtTimeMS" value="2021-02-10T00:00"></td></tr>
		<tr><td>End:</td><td><input type="datetime-local" id="endTimeMS" value="2021-03-10T00:00"></td></tr>
		<tr><td><input type="radio" id="damRadioMS" name="damtuhurspotMS" value="0">Dam</td></tr>
		<tr><td><input type="radio" id="tuhurRadioMS" name="damtuhurspotMS" value="1">Tuhur</td></tr>
		<tr><td><input type="radio" id="spotRadioMS" name="damtuhurspotMS" value="2">Spot</td></tr>
		<tr><td><input type="radio" id="spotRadioMS" name="damtuhurspotMS" value="3">Istimrar</td></tr>
	</table>
	<input type="button" value="Submit" id="submitButtonMS" onclick="submitMS()">
	<input type="button" value="Reset" onclick="resetMS()"><br>

	<p>Please enter both aadaat separated by a / (Example: 3/15)</p>
	<p><input type="text" id="aadatMS" onchange="onChangeAadat()" value=""><label for="numberofdays">Aadat</label></p>


	<p><span id="datesMS"></span></p>

	<p><span id="aadatTextMS"></span></p>

	<p><span id="solutionMS"></span></p>

	<p><span id="hallMS"></span></p>

  	<hr>

  	<p>!!!!Under Construction!!!!Nifaas ka Sawaal !!!Is Not Done Yet!!!!</p>
	<table>
		<tr><td>Adat:</td></tr>
		<tr><td>Haiz</td><td><input type="text" id="aadatHaizN" onchange="onChangeAadatN()" value=""></td></tr>
		<tr><td>Tuhr</td><td><input type="text" id="aadatTuhrN" onchange="onChangeAadatN()" value=""></td></tr>
		<tr><td>Nifaas</td><td><input type="text" id="aadatNifaasN" onchange="onChangeAadatN()" value=""></td></tr>
	</table>
	<p>&nbsp;</p>
  	<p>Wiladat kay baad khoon ki tarteeb</p>
	<input type="text" id="numberofdaysN" value="0"><label for="numberofdaysN">Days</label><br>
	<input type="radio" id="dam1N" name="damtuhurspotN" value="0">
	<label for="dam1N">Dam</label><br>
	<input type="radio" id="tuhur1N" name="damtuhurspotN" value="1">
	<label for="tuhur1N">Tuhur</label><br>
	<input type="radio" id="spot1N" name="damtuhurspotN" value="2">
	<label for="spot1N">Spot</label><br>

	<input type="button" value="Submit" id="submitButtonN" onclick="submitDimaAthaarN()">
	<input type="button" value="Reset" onclick="resetDimaAthaarN()"><br>

	<p><span id="aadatTextN"></span></p>

	<p><span id="solutionN"></span></p>

	<p><span id="hallN"></span></p>

	
	
	<script>
		start();
		calculateDuration();
		addTime();
	</script>
  </body>
</html>
